name: Database Integration Tests

on:
  workflow_dispatch: # Manual trigger from GitHub UI

jobs:
  test-postgres:
    name: PostgreSQL
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --extra postgres

      - name: Run PostgreSQL tests
        run: uv run pytest tests/database/test_postgres.py -v
        env:
          TEST_POSTGRES_URL: postgresql://test:test@localhost:5432/testdb

  test-mysql:
    name: MySQL
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: test
          MYSQL_DATABASE: testdb
        ports:
          - 3306:3306
        options: >-
          --health-cmd "mysqladmin ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --extra mysql

      - name: Run MySQL tests
        run: uv run pytest tests/database/test_mysql.py -v
        env:
          TEST_MYSQL_URL: mysql://root:test@localhost:3306/testdb

  test-oracle:
    name: Oracle
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4

      - name: Cache Oracle Docker image
        uses: actions/cache@v4
        id: cache-oracle
        with:
          path: ~/oracle-image.tar
          key: oracle-free-slim-faststart

      - name: Load cached Oracle image
        if: steps.cache-oracle.outputs.cache-hit == 'true'
        run: docker load -i ~/oracle-image.tar

      - name: Pull Oracle image
        if: steps.cache-oracle.outputs.cache-hit != 'true'
        run: |
          docker pull gvenzl/oracle-free:slim-faststart
          docker save gvenzl/oracle-free:slim-faststart -o ~/oracle-image.tar

      - name: Start Oracle container
        run: |
          docker run -d --name oracle \
            -e ORACLE_PASSWORD=test \
            -p 1521:1521 \
            gvenzl/oracle-free:slim-faststart

      - name: Wait for Oracle to be ready
        run: |
          echo "Waiting for Oracle to be ready..."
          for i in {1..30}; do
            if docker exec oracle healthcheck.sh 2>/dev/null; then
              echo "Oracle is ready!"
              exit 0
            fi
            echo "Attempt $i/30 - Oracle not ready yet..."
            sleep 10
          done
          echo "Oracle failed to start"
          docker logs oracle
          exit 1

      - name: Install dependencies
        run: uv sync --extra oracle

      - name: Run Oracle tests
        run: uv run pytest tests/database/test_oracle.py -v
        env:
          TEST_ORACLE_URL: oracle://system:test@localhost:1521/FREEPDB1

  test-mssql:
    name: SQL Server
    runs-on: ubuntu-latest

    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: Test@123!
        ports:
          - 1433:1433
        options: >-
          --health-cmd "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'Test@123!' -C -Q 'SELECT 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4

      - name: Install ODBC Driver 18
        run: |
          curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --batch --dearmor -o /usr/share/keyrings/microsoft-prod.gpg
          curl -fsSL https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql18

      - name: Wait for SQL Server
        run: |
          echo "Waiting for SQL Server..."
          for i in {1..30}; do
            if docker exec ${{ job.services.mssql.id }} /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'Test@123!' -C -Q "SELECT 1" 2>/dev/null; then
              echo "SQL Server is ready!"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 5
          done
          exit 1

      - name: Create test database
        run: |
          docker exec ${{ job.services.mssql.id }} /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'Test@123!' -C -Q "CREATE DATABASE testdb"

      - name: Install dependencies
        run: uv sync --extra mssql

      - name: Run SQL Server tests
        run: uv run pytest tests/database/test_mssql.py -v
        env:
          TEST_MSSQL_URL: "mssql://sa:Test@123!@localhost:1433/testdb?driver=ODBC+Driver+18+for+SQL+Server&TrustServerCertificate=yes"
