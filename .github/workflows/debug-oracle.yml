name: Debug Oracle

on:
  workflow_dispatch:

jobs:
  debug-oracle:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.5.14"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --extra oracle

      - name: Start Oracle container
        run: |
          docker run -d \
            --name oracle \
            -p 1521:1521 \
            -e ORACLE_PASSWORD=test \
            gvenzl/oracle-free:slim-faststart

          echo "Waiting for Oracle to be ready..."
          for i in {1..60}; do
            if docker logs oracle 2>&1 | grep -q "DATABASE IS READY TO USE"; then
              echo "Oracle is ready!"
              break
            fi
            echo "Attempt $i/60 - waiting..."
            sleep 5
          done
          sleep 5

      - name: Run comprehensive Oracle debug
        env:
          TEST_ORACLE_URL: "oracle://system:test@localhost:1521/FREEPDB1"
        run: |
          uv run python << 'PYEOF'
          import ibis

          def section(title):
              print(f'\n{"=" * 60}')
              print(f' {title}')
              print('=' * 60)

          def test(name, fn):
              try:
                  result = fn()
                  print(f'  ✓ {name}: {result}')
                  return result
              except Exception as e:
                  print(f'  ✗ {name}: {type(e).__name__}: {str(e)[:100]}')
                  return None

          # Connect
          section('CONNECTION')
          con = ibis.oracle.connect(
              host='localhost', port=1521,
              user='system', password='test',
              database='FREEPDB1',
          )
          print(f'  Connected to Oracle backend: {con.name}')

          # Setup test tables
          section('SETUP TEST TABLES')
          for table in ['TEST_TABLE', 'TEST_CLOB']:
              try:
                  con.raw_sql(f'DROP TABLE {table} PURGE')
              except:
                  pass

          # Normal table (VARCHAR2)
          con.raw_sql('''
              CREATE TABLE TEST_TABLE (
                  id NUMBER(10),
                  name VARCHAR2(100),
                  department VARCHAR2(50)
              )
          ''')
          con.raw_sql("INSERT INTO TEST_TABLE VALUES (1, 'Alice', 'Eng')")
          con.raw_sql("INSERT INTO TEST_TABLE VALUES (2, 'Bob', 'Eng')")
          con.raw_sql("INSERT INTO TEST_TABLE VALUES (3, 'Charlie', 'Sales')")
          print('  Created TEST_TABLE (VARCHAR2 columns)')

          # Table with CLOB (to test ORA-22849)
          con.raw_sql('''
              CREATE TABLE TEST_CLOB (
                  id NUMBER(10),
                  name VARCHAR2(100),
                  notes CLOB
              )
          ''')
          con.raw_sql("INSERT INTO TEST_CLOB VALUES (1, 'Alice', 'Some long notes')")
          con.raw_sql("INSERT INTO TEST_CLOB VALUES (2, 'Bob', 'Other notes')")
          con.raw_sql('COMMIT')
          print('  Created TEST_CLOB (with CLOB column)')

          #############################################
          section('Q1: Does Ibis list_tables() work?')
          #############################################
          test('con.list_tables()', lambda: con.list_tables())
          test('raw_sql user_tables', lambda: [r[0] for r in con.raw_sql('SELECT table_name FROM user_tables').fetchall()])

          #############################################
          section('Q2: Does Ibis list_schemas() exist and work?')
          #############################################
          test('hasattr list_schemas', lambda: hasattr(con, 'list_schemas'))
          if hasattr(con, 'list_schemas'):
              test('con.list_schemas()', lambda: con.list_schemas()[:5])
          test('raw_sql all_users', lambda: [r[0] for r in con.raw_sql('SELECT username FROM all_users WHERE rownum <= 5').fetchall()])

          #############################################
          section('Q3: Column names - UPPERCASE or lowercase?')
          #############################################
          table = con.table('TEST_TABLE')
          test('table.columns', lambda: table.columns)
          test('table.schema()', lambda: table.schema())
          
          # Try accessing with different cases
          test('table["ID"]', lambda: table['ID'].name())
          test('table["id"]', lambda: table['id'].name())

          #############################################
          section('Q4: Stats on normal table (VARCHAR2)')
          #############################################
          table = con.table('TEST_TABLE')
          test('nunique(ID)', lambda: table['ID'].nunique().to_pyarrow().as_py())
          test('nunique(NAME)', lambda: table['NAME'].nunique().to_pyarrow().as_py())
          test('count(ID)', lambda: table['ID'].count().to_pyarrow().as_py())
          
          print('\n  Aggregate all columns at once:')
          def agg_test():
              agg = []
              for col in table.columns:
                  agg.append(table[col].nunique().name(f'{col}_d'))
                  agg.append(table[col].count().name(f'{col}_c'))
              return table.aggregate(agg).to_pyarrow().to_pylist()[0]
          test('aggregate', agg_test)

          #############################################
          section('Q5: Stats on CLOB table (expect ORA-22849)')
          #############################################
          clob_table = con.table('TEST_CLOB')
          test('clob_table.columns', lambda: clob_table.columns)
          test('clob_table.schema()', lambda: clob_table.schema())
          
          test('nunique(ID) on CLOB table', lambda: clob_table['ID'].nunique().to_pyarrow().as_py())
          test('nunique(NOTES) - CLOB column', lambda: clob_table['NOTES'].nunique().to_pyarrow().as_py())
          
          print('\n  Aggregate all columns (should fail with ORA-22849):')
          def clob_agg_test():
              agg = []
              for col in clob_table.columns:
                  agg.append(clob_table[col].nunique().name(f'{col}_d'))
              return clob_table.aggregate(agg).to_pyarrow().to_pylist()[0]
          test('aggregate with CLOB', clob_agg_test)

          #############################################
          section('Q6: Can we detect CLOB type in schema?')
          #############################################
          for col, dtype in clob_table.schema().items():
              print(f'  {col}: {dtype} (type class: {type(dtype).__name__})')
          
          # Check if CLOB has a specific type
          import ibis.expr.datatypes as dt
          notes_type = clob_table.schema()['NOTES']
          test('is String', lambda: isinstance(notes_type, dt.String))
          test('is Binary', lambda: isinstance(notes_type, dt.Binary))
          test('type name', lambda: str(notes_type))

          #############################################
          section('Q7: Table name case sensitivity')
          #############################################
          test('con.table("TEST_TABLE")', lambda: con.table('TEST_TABLE').columns)
          test('con.table("test_table")', lambda: con.table('test_table').columns)

          #############################################
          section('Q8: Schema-qualified access')
          #############################################
          test('con.table("TEST_TABLE", database="SYSTEM")', 
               lambda: con.table('TEST_TABLE', database='SYSTEM').columns)
          test('con.table("test_table", database="system")',
               lambda: con.table('test_table', database='system').columns)

          #############################################
          section('Q9: Raw SQL vs Ibis for table listing')
          #############################################
          # What our code currently does
          test('raw: user_tables', lambda: [r[0] for r in con.raw_sql('SELECT table_name FROM user_tables').fetchall()])
          test('raw: all_tables SYSTEM', lambda: [r[0] for r in con.raw_sql("SELECT table_name FROM all_tables WHERE owner='SYSTEM' AND rownum <= 5").fetchall()])
          
          # Does Ibis have these?
          test('ibis: list_tables()', lambda: con.list_tables())
          test('ibis: list_tables(database="SYSTEM")', lambda: con.list_tables(database='SYSTEM'))

          section('DEBUG COMPLETE')
          PYEOF

      - name: Cleanup
        if: always()
        run: docker stop oracle && docker rm oracle || true
