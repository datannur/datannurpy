name: Debug Oracle

on:
  workflow_dispatch:
    inputs:
      test_name:
        description: "Test to run"
        required: true
        default: "test_raw_sql_stats"
        type: choice
        options:
          - test_raw_sql_stats
          - test_nunique
          - test_count
          - test_schemas

jobs:
  debug-oracle:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.5.14"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --extra oracle

      - name: Start Oracle container
        run: |
          docker run -d \
            --name oracle \
            -p 1521:1521 \
            -e ORACLE_PASSWORD=test \
            gvenzl/oracle-free:slim-faststart

          echo "Waiting for Oracle to be ready..."
          for i in {1..60}; do
            if docker logs oracle 2>&1 | grep -q "DATABASE IS READY TO USE"; then
              echo "Oracle is ready!"
              break
            fi
            echo "Attempt $i/60 - waiting..."
            sleep 5
          done
          sleep 5

      - name: Run debug test - ${{ inputs.test_name }}
        env:
          TEST_ORACLE_URL: "oracle://system:test@localhost:1521/FREEPDB1"
        run: |
          uv run python << 'PYEOF'
          import ibis
          import ibis.expr.datatypes as dt

          print('=' * 60)
          print('DEBUG TEST: ${{ inputs.test_name }}')
          print('=' * 60)

          # Connect
          con = ibis.oracle.connect(
              host='localhost',
              port=1521,
              user='system',
              password='test',
              database='FREEPDB1',
          )
          print(f'Connected to Oracle')

          # Create test table via raw SQL (most reliable)
          print('\n--- Setting up TEST_TABLE ---')
          try:
              con.raw_sql('DROP TABLE TEST_TABLE PURGE')
          except:
              pass

          con.raw_sql('''
              CREATE TABLE TEST_TABLE (
                  id NUMBER(10),
                  name VARCHAR2(100),
                  description VARCHAR2(4000),
                  amount NUMBER(10,2)
              )
          ''')
          con.raw_sql("INSERT INTO TEST_TABLE VALUES (1, 'Alice', 'A description', 100.50)")
          con.raw_sql("INSERT INTO TEST_TABLE VALUES (2, 'Bob', 'Another desc', 200.00)")
          con.raw_sql("INSERT INTO TEST_TABLE VALUES (3, 'Alice', NULL, 150.25)")
          con.raw_sql('COMMIT')
          print('TEST_TABLE created with 3 rows')

          # Verify
          result = con.raw_sql('SELECT COUNT(*) FROM TEST_TABLE').fetchone()
          print(f'Row count: {result[0]}')

          test_name = '${{ inputs.test_name }}'

          if test_name == 'test_raw_sql_stats':
              print('\n--- Testing raw SQL for stats ---')
              raw_sql = con.raw_sql

              print('\nCOUNT(DISTINCT col):')
              for col in ['ID', 'NAME', 'DESCRIPTION', 'AMOUNT']:
                  try:
                      result = raw_sql(f'SELECT COUNT(DISTINCT {col}) FROM TEST_TABLE').fetchone()
                      print(f'  {col}: {result[0]} ✓')
                  except Exception as e:
                      print(f'  {col}: FAILED - {type(e).__name__}: {e}')

              print('\nCOUNT(col):')
              for col in ['ID', 'NAME', 'DESCRIPTION', 'AMOUNT']:
                  try:
                      result = raw_sql(f'SELECT COUNT({col}) FROM TEST_TABLE').fetchone()
                      print(f'  {col}: {result[0]} ✓')
                  except Exception as e:
                      print(f'  {col}: FAILED - {type(e).__name__}: {e}')

              print('\nCombined aggregation query:')
              try:
                  result = raw_sql('''
                      SELECT 
                          COUNT(DISTINCT ID) as id_distinct,
                          COUNT(DISTINCT NAME) as name_distinct,
                          COUNT(DISTINCT DESCRIPTION) as desc_distinct,
                          COUNT(ID) as id_count,
                          COUNT(NAME) as name_count,
                          COUNT(DESCRIPTION) as desc_count
                      FROM TEST_TABLE
                  ''').fetchone()
                  print(f'  Result: {result} ✓')
              except Exception as e:
                  print(f'  FAILED: {type(e).__name__}: {e}')

              print('\n--- Now testing via Ibis ---')
              table = con.table('TEST_TABLE')
              print(f'Table columns: {table.columns}')
              print(f'Schema: {table.schema()}')

              print('\nIbis nunique() per column:')
              for col in table.columns:
                  try:
                      result = table[col].nunique().to_pyarrow().as_py()
                      print(f'  {col}: {result} ✓')
                  except Exception as e:
                      print(f'  {col}: FAILED - {type(e).__name__}: {str(e)[:80]}')

              print('\nIbis count() per column:')
              for col in table.columns:
                  try:
                      result = table[col].count().to_pyarrow().as_py()
                      print(f'  {col}: {result} ✓')
                  except Exception as e:
                      print(f'  {col}: FAILED - {type(e).__name__}: {str(e)[:80]}')

              print('\nIbis aggregate (like build_variables):')
              try:
                  agg_exprs = []
                  for col in table.columns:
                      agg_exprs.append(table[col].nunique().name(f'{col}_distinct'))
                      agg_exprs.append(table[col].count().name(f'{col}_count'))
                  result = table.aggregate(agg_exprs).to_pyarrow().to_pylist()[0]
                  print(f'  Result: {result} ✓')
              except Exception as e:
                  print(f'  FAILED: {type(e).__name__}: {str(e)[:100]}')

          elif test_name == 'test_schemas':
              print('\n--- Testing schema operations ---')
              print(f'Ibis list_tables(): {con.list_tables()[:10]}...')
              
              result = con.raw_sql('SELECT table_name FROM user_tables').fetchall()
              print(f'user_tables: {[r[0] for r in result]}')
              
              if hasattr(con, 'list_schemas'):
                  schemas = con.list_schemas()
                  print(f'Ibis list_schemas(): {schemas[:10]}...')

          print('\n' + '=' * 60)
          print('DEBUG COMPLETE')
          print('=' * 60)
          PYEOF

      - name: Cleanup
        if: always()
        run: docker stop oracle && docker rm oracle || true
